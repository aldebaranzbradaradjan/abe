function toggleToc(){var x=document.getElementById("toc");-1==x.className.indexOf("show")?x.className+=" show":x.className=x.className.replace(" show","")}async function getCountComments(post_id,parent_id){const settings={method:"POST",body:JSON.stringify({post_id:post_id,parent_id:parent_id}),headers:{Accept:"application/json","Content-Type":"application/json"}},response=await fetch("/api/v1/comment/count",settings);if(!response.ok)throw Error(response.message);return await response.json()}async function getComments(post_id,parent_id,page_size,page){const settings={method:"POST",body:JSON.stringify({post_id:post_id,parent_id:parent_id,page_size:page_size,page:page}),headers:{Accept:"application/json","Content-Type":"application/json"}},response=await fetch("/api/v1/comment/list",settings);if(!response.ok)throw Error(response.message);return await response.json()}async function getComment(comment_id){const settings={method:"POST",body:JSON.stringify({id:comment_id}),headers:{Accept:"application/json","Content-Type":"application/json"}},response=await fetch("/api/v1/comment",settings);if(!response.ok)throw Error(response.message);return await response.json()}async function createComments(post_id,parent_id,text){const settings={method:"POST",body:JSON.stringify({post_id:post_id,parent_id:parent_id,body:text}),headers:{Accept:"application/json","Content-Type":"application/json"}},response=await fetch("/api/v1/comment/user_restricted/create",settings);if(!response.ok)throw Error(response.message);return await response.json()}async function disconnect(){const settings={method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}},response=await fetch("/api/v1/logout",settings);if(!response.ok)throw Error(response.message);window.location.reload()}function appendEditor(node,id){document.querySelectorAll("[id^='editor']").forEach(node=>{node.parentNode.remove()}),document.querySelectorAll("[id^='append_com_']").forEach(node=>{node.innerText="Répondre"});var editor_template=document.querySelector("#comment_editor_template"),clone=document.importNode(editor_template.content,!0);const id_textbox_editor=null!==id?"editor_"+id:"root_editor";clone.querySelector(".editor").id=id_textbox_editor;const btns=clone.querySelectorAll("[data-edit]");btns.forEach(btn=>btn.addEventListener("click",(function(e){e.preventDefault();const cmd_val=this.getAttribute("data-edit").split(":");document.execCommand(cmd_val[0],!1,cmd_val[1])}))),clone.getElementById("send_comment").onclick=function(){createComments(postId,id,document.getElementById(id_textbox_editor).innerHTML).then(value=>{"root_editor"===id_textbox_editor?document.getElementById(id_textbox_editor).innerHTML="":(document.getElementById("append_com_"+id).innerText="Répondre",document.getElementById(id_textbox_editor).parentNode.remove())}).catch(error=>{console.error(error)})},null===node?document.getElementById("comments").appendChild(clone):node.parentNode.insertBefore(clone,node.nextSibling)}async function appendComment(node,comment){var comment_template=document.querySelector("#comment_template"),clone=document.importNode(comment_template.content,!0),divs=clone.querySelector(".comment");divs.id="comment_"+comment[0].id,divs.querySelector(".top .user").textContent=comment[1].username,divs.querySelector(".top time").textContent=comment[0].created_at,divs.querySelector(".body").innerHTML=comment[0].body;const id_append_com=null!==comment[0].id?"append_com_"+comment[0].id:"append_com_root";divs.querySelector(".bottom a").id=id_append_com,checkCookie("CookieChecker")?divs.querySelector(".bottom a").onclick=function(){document.getElementById("editor_"+comment[0].id)?(document.getElementById(id_append_com).innerText="Répondre",document.getElementById("editor_"+comment[0].id).parentNode.remove()):(appendEditor(divs,comment[0].id),document.getElementById(id_append_com).innerText="Annuler")}:divs.querySelector(".bottom a").remove();var data=await getComments(null,comment[0].id,10,1);if(clone.querySelector(".subcomments").id="subcomments"+comment[0].id,data[0].length>0){let a=document.createElement("a");a.innerText="Charger les sous commentaires",a.onclick=async function(){a.remove(),data=await getComments(null,comment[0].id,10,1);for(var i=0;i<data[1];i++){for(const cmt of data[0])await appendComment(document.getElementById("subcomments"+comment[0].id),cmt);data=await getComments(null,comment[0].id,10,i+2)}},divs.querySelector(".bottom").append(a)}node.appendChild(clone)}async function renderComments(node,post_id,parent_id,page_size,page){const show_more_comments=node.getElementsByClassName("show_more_comments");show_more_comments.length>0&&show_more_comments[0].remove();var data=null!==parent_id?await getComments(null,parent_id,page_size,page):await getComments(post_id,null,page_size,page);if(0!==data[1]){for(const cmt of data[0])await appendComment(node,cmt);if(data[1]>page){const show_more_comments=node.getElementsByClassName("show_more_comments");show_more_comments.length>0&&show_more_comments[0].remove();var show_more_comments_template=document.querySelector("#show_more_comments_template"),clone=document.importNode(show_more_comments_template.content,!0),a;clone.querySelector("div").querySelector("a").onclick=function(){renderComments(node,post_id,parent_id,page_size,parseInt(page+1))},node.appendChild(clone)}}}async function updateCommentCounter(){const comment_counter=document.getElementById("comment_counter"),count=await getCountComments(postId,null);comment_counter.innerText=count>0?count+" commentaires":"Il n'y a pas encore de commentaires, écrivez le premier !"}async function initComments(){const count=await getCountComments(postId,null);if(count>0){let h=document.createElement("h2");h.className="header",h.id="comment_counter",h.innerText=count+" commentaires",document.getElementById("comments").appendChild(h),checkCookie("CookieChecker")&&appendEditor(null,null),await renderComments(document.getElementById("comments"),postId,null,10,1)}else{let h=document.createElement("h2");h.className="header",h.id="comment_counter",h.innerText="Il n'y a pas encore de commentaires, écrivez le premier !",document.getElementById("comments").appendChild(h),checkCookie("CookieChecker")&&appendEditor(null,null)}if(!checkCookie("CookieChecker")){let p=document.createElement("p");p.innerText="Vous devez être connecté pour pouvoir écrire un commentaire.";let a=document.createElement("a");a.onclick=function(){window.location.href="/blog/login"},a.innerText="Aller à la page de connexion",document.getElementById("comments").appendChild(p),document.getElementById("comments").appendChild(a)}}function updateTocOnScroll(){var sect;let pos=window.pageYOffset||document.documentElement.scrollTop;if(tocEndpointslocaction.forEach((function(id,offs){if(void 0!==id){var toc_entry=document.getElementById("toc-"+id);null!==toc_entry&&-1!==(toc_entry=toc_entry.parentElement).className.indexOf("toc-selected")&&(toc_entry.className=toc_entry.className.replace(" toc-selected","")),offs-window.innerHeight/4<=pos&&(sect=id)}})),void 0!==sect){let toc_entry=document.getElementById("toc-"+sect);null!==toc_entry&&(toc_entry.parentElement.className+=" toc-selected")}}function initTocWithDimensions(){let pos=window.pageYOffset||document.documentElement.scrollTop,tocEndpoints=document.querySelectorAll(".anchor-content");tocEndpointslocaction=[],tocEndpoints.forEach(node=>{tocEndpointslocaction[Math.round(node.getBoundingClientRect().top+pos)]=node.id}),updateTocOnScroll()}let socket;var tocEndpointslocaction=[],timeoutWindowResize=!1,timeoutWindowScroll=!1;let delay=150;window.onload=async function(){initTocWithDimensions();let logout_profile=document.getElementsByClassName("actions-container")[0].getElementsByTagName("a"),logout=logout_profile[0],profile=logout_profile[1],connect=logout_profile[2];checkCookie("CookieChecker")?(connect.remove(),logout.addEventListener("click",(function(e){e.preventDefault(),disconnect()})),profile.addEventListener("click",(function(e){e.preventDefault(),window.location.href="/blog/profile"}))):(logout.remove(),profile.remove(),connect.addEventListener("click",(function(e){e.preventDefault(),window.location.href="/blog/login"}))),-1===navigator.userAgent.indexOf("Firefox")&&(document.getElementsByClassName("toc aside-toc")[0].getElementsByTagName("ul")[0].style.alignSelf="start");let pos=window.pageYOffset||document.documentElement.scrollTop,tocEndpoints;document.querySelectorAll(".anchor-content").forEach(node=>{tocEndpointslocaction[Math.round(node.getBoundingClientRect().top+pos)]=node.id}),window.addEventListener("scroll",(function(e){clearTimeout(timeoutWindowScroll),timeoutWindowScroll=setTimeout(updateTocOnScroll,delay)}));for(var toc2=document.getElementById("toc2").getElementsByTagName("a"),i=0;i<toc2.length;i++){let href=toc2[i].href;toc2[i].id="toc-"+href.substring(href.indexOf("anchor-content"))}for(var toc=document.getElementById("toc").getElementsByTagName("a"),i=0;i<toc.length;i++)toc[i].onclick=function(){return toggleToc(),!0};window.addEventListener("resize",(function(){clearTimeout(timeoutWindowResize),timeoutWindowResize=setTimeout(initTocWithDimensions,delay)})),initComments(),socket=new WebSocket("ws://127.0.0.1:8080/api/v1/comment/ws"),socket.addEventListener("open",(function(event){socket.send("/join "+postId)})),socket.addEventListener("message",(async function(event){let cmd=event.data.trim().split(" ");if("/new_comment"===cmd[0]&&!isNaN(parseInt(cmd[1]))){await updateCommentCounter();const cmt=await getComment(parseInt(cmd[1]));let more_than_one_comment=null;if(null!==cmt[0].parent_id&&(more_than_one_comment=document.getElementById("comment_"+cmt[0].parent_id),null!==more_than_one_comment&&more_than_one_comment.querySelectorAll(".bottom a").length>1))return void more_than_one_comment.querySelectorAll(".bottom a")[1].onclick();null!==cmt[0].parent_id?null!==document.getElementById("subcomments"+cmt[0].parent_id)&&appendComment(document.getElementById("subcomments"+cmt[0].parent_id),cmt):appendComment(document.getElementById("comments"),cmt)}}))};